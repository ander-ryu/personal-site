<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <title>上传 Excel 更新网站</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <h1>📤 上传 Excel 更新网站</h1>
    <nav>
        <a href="/">网站首页</a>
        <a href="/resume.html">个人履历</a>
        <a href="/projects.html">过去项目</a>
        <a href="/hobby.html">未来兴趣</a>
        <a href="/contact.html">联系方式</a>
        <a href="/display.html">数据展示</a>
        <a href="/upload.html">后台管理</a>
    </nav>
    <div class="upload-container">
        <p>请选择导入模式：</p>
        <select id="mode">
            <option value="append">追加数据（只添加已有非重复数据）</option>
            <option value="overwrite">覆盖数据（先删除所有再导入）</option>
        </select>
        <br><br>
        <input type="file" id="fileInput" accept=".xlsx">
        <br><br>
        <button id="uploadBtn">开始上传 🚀</button>
        <p id="status"></p>

        <!-- ✅ 进度条 -->
        <div id="progress-container">
            <div id="progress-bar"></div>
        </div>
    </div>

    <!-- ✅ 登录框 -->
    <div id="login-box" style="
    position: fixed; 
    top: 0; left: 0; width: 100%; height: 100%; 
    background: rgba(0,0,0,0.6); 
    display: flex; 
    justify-content: center; 
    align-items: center;
    z-index: 9999;
  ">
        <div style="
      background: white; 
      padding: 30px; 
      border-radius: 10px; 
      text-align: center;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
    ">
            <h2>请输入后台管理密码</h2>
            <input type="password" id="password-input" placeholder="输入密码" style="
        padding: 10px; 
        width: 80%; 
        font-size: 16px; 
        border-radius: 5px; 
        border: 1px solid #ccc;
      "><br><br>
            <button onclick="checkPassword()" style="
        padding: 10px 20px; 
        background: #4CAF50; 
        color: white; 
        border: none; 
        border-radius: 5px; 
        cursor: pointer;
      ">确认</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script>
        let adminToken = null;

        // 验证密码
        async function checkPassword() {
            const input = document.getElementById("password-input").value;
            if (!input) {
                alert("请输入密码！");
                return;
            }

            // 调用后端验证
            const res = await fetch("/api/auth", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ password: input })
            });
            const json = await res.json();

            if (json.ok) {
                adminToken = input; // 记录在内存
                document.getElementById("login-box").style.display = "none";
                document.getElementById("upload-area").style.display = "block"; // ✅ 显示上传区域
            } else {
                alert("密码错误！");
            }
        }


        document.getElementById("uploadBtn").addEventListener("click", async () => {
            const file = document.getElementById("fileInput").files[0];
            const mode = document.getElementById("mode").value;
            const status = document.getElementById("status");
            const progressContainer = document.getElementById("progress-container");
            const progressBar = document.getElementById("progress-bar");

            if (!file) return alert("请选择 Excel 文件！");
            if (!adminToken) return alert("请先输入后台密码！");

            const reader = new FileReader();
            reader.onload = async function (e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: "array" });
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const rows = XLSX.utils.sheet_to_json(sheet);

                // ✅ 显示进度条
                progressContainer.style.display = "block";
                progressBar.style.width = "0%";
                progressBar.style.background = "#4CAF50";
                status.textContent = "正在上传中...";

                // 模拟上传进度（假装上传耗时）
                let progress = 0;
                const fakeProgress = setInterval(() => {
                    if (progress < 90) {
                        progress += 10;
                        progressBar.style.width = progress + "%";
                    }
                }, 200);

                try {
                    const res = await fetch("/api/upload", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "Authorization": `Bearer ${adminToken}`
                        },
                        body: JSON.stringify({ mode, rows })
                    });

                    const json = await res.json();
                    clearInterval(fakeProgress);
                    progressBar.style.width = "100%";

                    if (json.ok) {
                        progressBar.style.background = "#28a745"; // ✅ 绿色成功
                        status.innerHTML = `✅ 上传成功！已${mode === 'overwrite' ? '覆盖' : '追加'} ${json.count} 条记录。`;
                    } else {
                        progressBar.style.background = "#dc3545"; // ❌ 红色失败
                        status.innerHTML = `❌ 上传失败：${json.error}`;
                    }
                } catch (err) {
                    clearInterval(fakeProgress);
                    progressBar.style.background = "#dc3545";
                    progressBar.style.width = "100%";
                    status.innerHTML = `❌ 出错：${err.message}`;
                }
            };

            reader.readAsArrayBuffer(file);
        });

    </script>
</body>

</html>
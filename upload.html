<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <title>ä¸Šä¼  Excel æ›´æ–°ç½‘ç«™</title>
    <link rel="stylesheet" href="style.css">
    <style>
        #progress-container {
            width: 100%;
            max-width: 400px;
            height: 15px;
            background: #ddd;
            border-radius: 10px;
            margin: 10px auto;
            overflow: hidden;
            display: none;
        }

        #progress-bar {
            height: 100%;
            width: 0%;
            background: #4CAF50;
            transition: width 0.3s ease;
        }

        .upload-container {
            text-align: center;
            margin-top: 30px;
        }
    </style>
</head>

<body>
    <h1>ğŸ“¤ ä¸Šä¼  Excel æ›´æ–°ç½‘ç«™</h1>
    <nav>
        <a href="/">ç½‘ç«™é¦–é¡µ</a>
        <a href="/resume.html">ä¸ªäººå±¥å†</a>
        <a href="/projects.html">è¿‡å»é¡¹ç›®</a>
        <a href="/hobby.html">æœªæ¥å…´è¶£</a>
        <a href="/contact.html">è”ç³»æ–¹å¼</a>
        <a href="/display.html">æ•°æ®å±•ç¤º</a>
        <a href="/upload.html">åå°ç®¡ç†</a>
    </nav>

    <div class="upload-container" id="upload-area" style="display:none;">
        <p>è¯·é€‰æ‹©ç›®æ ‡æ•°æ®åº“è¡¨ï¼š</p>
        <select id="tableSelect">
            <option value="resume_data">ä¸ªäººå±¥å†ï¼ˆresume_dataï¼‰</option>
            <option value="project_data">è¿‡å»é¡¹ç›®ï¼ˆproject_dataï¼‰</option>
            <option value="hobby_data">æœªæ¥å…´è¶£ï¼ˆhobby_dataï¼‰</option>
            <option value="contact_data">è”ç³»æ–¹å¼ï¼ˆcontact_dataï¼‰</option>
            <option value="news_data">æœ€æ–°åŠ¨æ€ï¼ˆnews_dataï¼‰</option>
        </select>
        <br><br>

        <p>è¯·é€‰æ‹©å¯¼å…¥æ¨¡å¼ï¼š</p>
        <select id="mode">
            <option value="append">è¿½åŠ æ•°æ®ï¼ˆåªæ·»åŠ éé‡å¤æ•°æ®ï¼‰</option>
            <option value="overwrite">è¦†ç›–æ•°æ®ï¼ˆå…ˆåˆ é™¤æ‰€æœ‰å†å¯¼å…¥ï¼‰</option>
        </select>
        <br><br>

        <input type="file" id="fileInput" accept=".xlsx">
        <br><br>
        <button id="uploadBtn">å¼€å§‹ä¸Šä¼  ğŸš€</button>
        <p id="status"></p>

        <div id="progress-container">
            <div id="progress-bar"></div>
        </div>
    </div>

    <!-- âœ… ç™»å½•æ¡† -->
    <div id="login-box" style="
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.6);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;">
        <div style="
      background: white;
      padding: 30px;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);">
            <h2>è¯·è¾“å…¥åå°ç®¡ç†å¯†ç </h2>
            <input type="password" id="password-input" placeholder="è¾“å…¥å¯†ç " style="
        padding: 10px; width: 80%; font-size: 16px;
        border-radius: 5px; border: 1px solid #ccc;"><br><br>
            <button onclick="checkPassword()" style="
        padding: 10px 20px; background: #4CAF50; color: white;
        border: none; border-radius: 5px; cursor: pointer;">
                ç¡®è®¤
            </button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script>
        let adminToken = null;

        // âœ… éªŒè¯å¯†ç 
        async function checkPassword() {
            const input = document.getElementById("password-input").value;
            if (!input) {
                alert("è¯·è¾“å…¥å¯†ç ï¼");
                return;
            }

            const res = await fetch("/api/auth", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ password: input })
            });
            const json = await res.json();

            if (json.ok) {
                adminToken = input;
                document.getElementById("login-box").style.display = "none";
                document.getElementById("upload-area").style.display = "block";
            } else {
                alert("å¯†ç é”™è¯¯ï¼");
            }
        }

        // âœ… ä¸Šä¼ æŒ‰é’®é€»è¾‘
        document.getElementById("uploadBtn").addEventListener("click", async () => {
            const file = document.getElementById("fileInput").files[0];
            const mode = document.getElementById("mode").value;
            const table = document.getElementById("tableSelect").value;
            const status = document.getElementById("status");
            const progressContainer = document.getElementById("progress-container");
            const progressBar = document.getElementById("progress-bar");

            if (!file) return alert("è¯·é€‰æ‹© Excel æ–‡ä»¶ï¼");
            if (!adminToken) return alert("è¯·å…ˆè¾“å…¥åå°å¯†ç ï¼");

            const reader = new FileReader();
            reader.onload = async function (e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: "array" });
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const rows = XLSX.utils.sheet_to_json(sheet);

                progressContainer.style.display = "block";
                progressBar.style.width = "0%";
                status.textContent = "æ­£åœ¨ä¸Šä¼ ä¸­...";

                let progress = 0;
                const fakeProgress = setInterval(() => {
                    if (progress < 90) {
                        progress += 10;
                        progressBar.style.width = progress + "%";
                    }
                }, 200);

                try {
                    const res = await fetch("/api/upload", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "Authorization": `Bearer ${adminToken}`
                        },
                        body: JSON.stringify({ table, mode, rows })
                    });

                    const json = await res.json();
                    clearInterval(fakeProgress);
                    progressBar.style.width = "100%";

                    if (json.ok) {
                        progressBar.style.background = "#28a745";
                        status.innerHTML = `âœ… ä¸Šä¼ æˆåŠŸï¼å·²å°†æ•°æ®å¯¼å…¥è¡¨ <b>${table}</b>ï¼Œ${mode === 'overwrite' ? 'è¦†ç›–' : 'è¿½åŠ '} ${json.count} æ¡è®°å½•ã€‚`;
                    } else {
                        progressBar.style.background = "#dc3545";
                        status.innerHTML = `âŒ ä¸Šä¼ å¤±è´¥ï¼š${json.error}`;
                    }
                } catch (err) {
                    clearInterval(fakeProgress);
                    progressBar.style.background = "#dc3545";
                    progressBar.style.width = "100%";
                    status.innerHTML = `âŒ å‡ºé”™ï¼š${err.message}`;
                }
            };

            reader.readAsArrayBuffer(file);
        });
    </script>
</body>

</html>
<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <title>ä¸Šä¼  Excel æ›´æ–°ç½‘ç«™</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <h1>ğŸ“¤ ä¸Šä¼  Excel æ›´æ–°ç½‘ç«™</h1>
    <nav>
        <a href="/">ç½‘ç«™é¦–é¡µ</a>
        <a href="/resume.html">ä¸ªäººå±¥å†</a>
        <a href="/projects.html">è¿‡å»é¡¹ç›®</a>
        <a href="/hobby.html">æœªæ¥å…´è¶£</a>
        <a href="/contact.html">è”ç³»æ–¹å¼</a>
        <a href="/display.html">æ•°æ®å±•ç¤º</a>
        <a href="/upload.html">åå°ç®¡ç†</a>
    </nav>
    <div id="upload-area" style="display: none;">
        <p>è¯·é€‰æ‹©å¯¼å…¥æ¨¡å¼ï¼š</p>
        <select id="mode">
            <option value="overwrite">è¦†ç›–æ•°æ®ï¼ˆå…ˆåˆ é™¤æ‰€æœ‰å†å¯¼å…¥ï¼‰</option>
            <option value="append">è¿½åŠ æ•°æ®ï¼ˆä¿ç•™æ—§çš„å¹¶æ–°å¢ï¼‰</option>
        </select>
        <br><br>
        <input type="file" id="fileInput" accept=".xlsx">
        <button id="uploadBtn">å¼€å§‹ä¸Šä¼  ğŸš€</button>

        <p id="status"></p>
    </div>

    <!-- âœ… ç™»å½•æ¡† -->
    <div id="login-box" style="
    position: fixed; 
    top: 0; left: 0; width: 100%; height: 100%; 
    background: rgba(0,0,0,0.6); 
    display: flex; 
    justify-content: center; 
    align-items: center;
    z-index: 9999;
  ">
        <div style="
      background: white; 
      padding: 30px; 
      border-radius: 10px; 
      text-align: center;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
    ">
            <h2>è¯·è¾“å…¥åå°ç®¡ç†å¯†ç </h2>
            <input type="password" id="password-input" placeholder="è¾“å…¥å¯†ç " style="
        padding: 10px; 
        width: 80%; 
        font-size: 16px; 
        border-radius: 5px; 
        border: 1px solid #ccc;
      "><br><br>
            <button onclick="checkPassword()" style="
        padding: 10px 20px; 
        background: #4CAF50; 
        color: white; 
        border: none; 
        border-radius: 5px; 
        cursor: pointer;
      ">ç¡®è®¤</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script>
        let adminToken = null;

        // éªŒè¯å¯†ç 
        async function checkPassword() {
            const input = document.getElementById("password-input").value;
            if (!input) {
                alert("è¯·è¾“å…¥å¯†ç ï¼");
                return;
            }

            // è°ƒç”¨åç«¯éªŒè¯
            const res = await fetch("/api/auth", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ password: input })
            });
            const json = await res.json();

            if (json.ok) {
                adminToken = input; // è®°å½•åœ¨å†…å­˜
                document.getElementById("login-box").style.display = "none";
                document.getElementById("upload-area").style.display = "block"; // âœ… æ˜¾ç¤ºä¸Šä¼ åŒºåŸŸ
            } else {
                alert("å¯†ç é”™è¯¯ï¼");
            }
        }


        document.getElementById("uploadBtn").addEventListener("click", async () => {
            const file = document.getElementById("fileInput").files[0];
            const mode = document.getElementById("mode").value;
            const status = document.getElementById("status");

            if (!file) return alert("è¯·é€‰æ‹© Excel æ–‡ä»¶ï¼");
            if (!adminToken) return alert("è¯·å…ˆè¾“å…¥åå°å¯†ç ï¼");

            const reader = new FileReader();
            reader.onload = async function (e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: "array" });
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const rows = XLSX.utils.sheet_to_json(sheet);

                status.textContent = "æ­£åœ¨ä¸Šä¼ ä¸­...";

                const res = await fetch("/api/upload", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${adminToken}` // âœ… åç«¯éªŒè¯ç”¨
                    },
                    body: JSON.stringify({ mode, rows })
                });

                const json = await res.json();
                if (json.ok) {
                    status.innerHTML = `âœ… ä¸Šä¼ æˆåŠŸï¼å·²${mode === 'overwrite' ? 'è¦†ç›–' : 'è¿½åŠ '} ${json.count} æ¡è®°å½•ã€‚`;
                } else {
                    status.innerHTML = `âŒ ä¸Šä¼ å¤±è´¥ï¼š${json.error}`;
                }
            };
            reader.readAsArrayBuffer(file);
        });
    </script>
</body>

</html>